<script lang="ts">
	import L, { marker } from 'leaflet';
	import { onDestroy, onMount } from 'svelte';
	import difference from '@turf/difference';
	import polygon from 'turf-polygon';
	import { GeoPoint, collection, doc, getDoc, setDoc } from 'firebase/firestore';
	import { db } from './firebase';
	import { v4 as uuidv4 } from 'uuid';

	const PutrajayaGeoJson = {
		type: 'FeatureCollection',
		crs: {
			type: 'name',
			properties: {
				name: 'urn:ogc:def:crs:OGC:1.3:CRS84'
			}
		},
		features: [
			{
				type: 'Feature',
				properties: {
					name: 'Perbadanan Putrajaya',
					statename: 'WP Putra Jaya',
					subname: null,
					id: '431'
				},
				geometry: {
					type: 'Polygon',
					coordinates: [
						[
							[101.70264698411732, 2.975577014972509],
							[101.70022101542062, 2.973388982997655],
							[101.6996059838613, 2.972147014518567],
							[101.69928398364605, 2.967271015010836],
							[101.70018398416958, 2.963755014766916],
							[101.7006370153472, 2.958747014933481],
							[101.70082401494491, 2.958687983684108],
							[101.70105101562399, 2.95896001489902],
							[101.70183298380744, 2.959310983404341],
							[101.70173801481394, 2.960555983303708],
							[101.70226401524368, 2.960916014866895],
							[101.70286998370007, 2.961080014843091],
							[101.70337998423632, 2.961328014432699],
							[101.70396001563552, 2.961262014525615],
							[101.70463301548004, 2.961542983070646],
							[101.70550598390011, 2.961451983256171],
							[101.70837701481949, 2.961752014557463],
							[101.70900498391548, 2.962062983404829],
							[101.70978398406525, 2.961906983150773],
							[101.71031901525862, 2.961566983602123],
							[101.71097101518679, 2.961546983308797],
							[101.71239098395299, 2.962257015031645],
							[101.71279898438203, 2.962634983849251],
							[101.7129199838575, 2.963048014456904],
							[101.71338001560609, 2.963370014751793],
							[101.71375401569989, 2.964110014277649],
							[101.71395198372728, 2.964161983161343],
							[101.71434601535358, 2.963802014554526],
							[101.71514198378074, 2.964125014911516],
							[101.71514590313035, 2.962706561035871],
							[101.71514750392819, 2.961566202214517],
							[101.71515098759488, 2.960357933194202],
							[101.715152740208, 2.959288982498623],
							[101.71515398257804, 2.95798344273023],
							[101.71515698384943, 2.956999983414325],
							[101.71516098404736, 2.955512983112616],
							[101.72312604114275, 2.955464256016609],
							[101.72729968671632, 2.955473152760038],
							[101.73089801524934, 2.955474014892793],
							[101.73239001542663, 2.953491014514099],
							[101.73239156142724, 2.950526279684011],
							[101.73240901569316, 2.945550983301781],
							[101.73241169716431, 2.944978750671701],
							[101.73241401571606, 2.943840014497784],
							[101.7324150038629, 2.943254772599529],
							[101.73242236016672, 2.942345865302806],
							[101.73247061496886, 2.938465456447122],
							[101.73251042201404, 2.935626246641535],
							[101.73253276581009, 2.933638857117762],
							[101.73258776516339, 2.931265671529845],
							[101.73261998413932, 2.929437014467589],
							[101.72945718311058, 2.929422344411428],
							[101.72790117527435, 2.929403767304162],
							[101.72194498381791, 2.929373983105696],
							[101.72049101561481, 2.929372014777385],
							[101.71837629699435, 2.929325550923747],
							[101.71525501519972, 2.929275014942861],
							[101.71525501519972, 2.929507014819864],
							[101.71130798402966, 2.92952301443835],
							[101.70749698384471, 2.929518983582386],
							[101.70750893952281, 2.928388181223447],
							[101.70753495473342, 2.927805716858954],
							[101.70758009597478, 2.926787334727326],
							[101.70772401506646, 2.92389201470563],
							[101.70749114659198, 2.921607269028619],
							[101.70737280792636, 2.920408669246611],
							[101.7072220149261, 2.918542983449588],
							[101.70719885186654, 2.918146758829147],
							[101.70712298375085, 2.916830014866937],
							[101.70712144942837, 2.916246275034217],
							[101.70718498367512, 2.913209983105853],
							[101.70038598383599, 2.913293014738871],
							[101.70041098395036, 2.909642014299335],
							[101.69810158154317, 2.909662687492526],
							[101.69734401519609, 2.909678983455518],
							[101.69734707306135, 2.909219231580016],
							[101.69735239827435, 2.908308959025121],
							[101.69737598444046, 2.90655601448794],
							[101.69893255462205, 2.906167067000554],
							[101.70047851839509, 2.905789319527963],
							[101.70140601545123, 2.905565983120653],
							[101.70147198413244, 2.905080983463545],
							[101.7015537802306, 2.903599313307579],
							[101.70166901521694, 2.901471014247944],
							[101.70089198417432, 2.899862014610195],
							[101.69920901564231, 2.899404983429029],
							[101.69744401565353, 2.898732983067224],
							[101.69745229542552, 2.897029750066273],
							[101.69745965801761, 2.895661834794186],
							[101.69746098393091, 2.894978983644943],
							[101.69746162712467, 2.894806602507607],
							[101.69746698377872, 2.893637014742001],
							[101.69414101545674, 2.893152983400441],
							[101.69199501480313, 2.893319983562686],
							[101.68979298442868, 2.893222014371823],
							[101.6882320151971, 2.891890014550698],
							[101.68795501518764, 2.889424983519703],
							[101.68732898375772, 2.887727014612606],
							[101.68624801492521, 2.888168983358623],
							[101.68641079684124, 2.889627167770722],
							[101.6865858039299, 2.891022545581657],
							[101.68662040613633, 2.891294997836591],
							[101.68668683385665, 2.891808573824172],
							[101.68678601505053, 2.892569983156871],
							[101.6851029836365, 2.893283014768667],
							[101.68489288206459, 2.891523127059537],
							[101.68484498389364, 2.891128983368011],
							[101.68339482814062, 2.891742600326926],
							[101.68143669216234, 2.892567351755095],
							[101.68128701486972, 2.892631983037019],
							[101.68095520505155, 2.890156506042552],
							[101.68044998355265, 2.886292983320062],
							[101.67928590618327, 2.886295622810968],
							[101.67536646317389, 2.886296584583351],
							[101.6733428570794, 2.886314889659174],
							[101.6713702510386, 2.886291784693285],
							[101.6684402762635, 2.88639689600043],
							[101.6675780148633, 2.886434982899543],
							[101.66667201539026, 2.886447014921428],
							[101.66578601511033, 2.886460983048063],
							[101.66492898370173, 2.886494983310453],
							[101.66315601565641, 2.886565015037387],
							[101.66329398430763, 2.887181014668371],
							[101.66405201508374, 2.888354014762129],
							[101.66404501541105, 2.889264014480647],
							[101.66365898418061, 2.889782014450089],
							[101.66290998416811, 2.890162983629119],
							[101.66232398436216, 2.890849983511166],
							[101.66197898368237, 2.892190014234668],
							[101.66152998414377, 2.893935014172575],
							[101.66147398406727, 2.894122983762992],
							[101.66080998354526, 2.896702014834143],
							[101.66017298368565, 2.899171014348591],
							[101.66010398408871, 2.899439983642544],
							[101.66047298415967, 2.901447014221704],
							[101.66245998390629, 2.903314983791615],
							[101.66292098403876, 2.903748014311653],
							[101.66341098358518, 2.904209014573695],
							[101.66364201500488, 2.905281014424288],
							[101.6639319839921, 2.906624983634441],
							[101.66503801492276, 2.907513983219624],
							[101.66581201504962, 2.908814983086529],
							[101.66639801485557, 2.908984014791997],
							[101.66678498392713, 2.909096015059784],
							[101.66711601490594, 2.909191014180762],
							[101.66786101561885, 2.909002983397643],
							[101.66855801485455, 2.909228014752276],
							[101.66945098426437, 2.909632014585075],
							[101.66997798362081, 2.91008498378654],
							[101.67000698393309, 2.910108983629133],
							[101.6702749837217, 2.910595983577575],
							[101.67026998369886, 2.910887014809928],
							[101.67026098437631, 2.911454983629405],
							[101.67025301542139, 2.91190598373906],
							[101.66993901560204, 2.913001014304105],
							[101.66970498380931, 2.914555014960254],
							[101.67030801567299, 2.915142015026784],
							[101.67169696651079, 2.91511657087534],
							[101.67224201481787, 2.915329014853738],
							[101.67294401497473, 2.916811014992863],
							[101.67307798432627, 2.917833983439126],
							[101.67447101531212, 2.919005014762767],
							[101.67388898426313, 2.9220119830308],
							[101.6735610156411, 2.922593014969988],
							[101.67322201480906, 2.923608014184639],
							[101.67254401494164, 2.923891014388016],
							[101.67198801527297, 2.924288014806556],
							[101.67151998402677, 2.925010014857348],
							[101.6711519837807, 2.926736983443477],
							[101.67071301483062, 2.927504014904995],
							[101.67017201523059, 2.92908498330615],
							[101.66965998360341, 2.929987014938705],
							[101.669571015356, 2.930514014250837],
							[101.66906298392688, 2.931709983579943],
							[101.66957898431092, 2.93256598359278],
							[101.66979098402302, 2.933171014791045],
							[101.66969801557765, 2.934224983253041],
							[101.66992401553347, 2.934958983279747],
							[101.669971983773, 2.935654014807962],
							[101.6704719842635, 2.936827014662478],
							[101.67044798397406, 2.937633983236649],
							[101.67017498416261, 2.937983983285206],
							[101.67016398429195, 2.938671982989094],
							[101.67055798357893, 2.939305014902243],
							[101.66996698375014, 2.940364982981464],
							[101.67061398365537, 2.941494983745689],
							[101.67008898394889, 2.942969015032261],
							[101.67024301537568, 2.944578983678497],
							[101.670745015516, 2.945326014863978],
							[101.67168698353304, 2.946013014224782],
							[101.6724149836292, 2.946109014998812],
							[101.6729169837695, 2.94601801481664],
							[101.67337098422929, 2.945960983486602],
							[101.67355601561826, 2.945954983493728],
							[101.67427901479317, 2.946389014891615],
							[101.67457621881169, 2.947017673411953],
							[101.67501198436949, 2.949831983203877],
							[101.67488201521587, 2.950655983235951],
							[101.67433398360373, 2.951372983609575],
							[101.67316201543292, 2.952352014329017],
							[101.67216929799227, 2.953513761940351],
							[101.67134498951448, 2.954123867547191],
							[101.66932998389059, 2.955763983020392],
							[101.66875101519838, 2.955552983019533],
							[101.66817598382205, 2.955546015085514],
							[101.66663601540523, 2.956669014559196],
							[101.66567298369144, 2.95723598315584],
							[101.66438401534475, 2.958291014351622],
							[101.663340832348, 2.961093668049917],
							[101.66297301535833, 2.964247014258],
							[101.66315298384232, 2.964906983561374],
							[101.66346598383679, 2.964980014820816],
							[101.664229015534, 2.964358982967891],
							[101.6648639843027, 2.964265014836971],
							[101.66524798354398, 2.964430983480449],
							[101.66555801550476, 2.965516014435391],
							[101.66548598409371, 2.96621401424032],
							[101.66566101543688, 2.96669798349113],
							[101.66581398415674, 2.966919983540314],
							[101.66599901554569, 2.967103014837123],
							[101.66621498401473, 2.967257014698284],
							[101.66644598399338, 2.967398983385432],
							[101.66668898366765, 2.967535014975939],
							[101.666971015141, 2.967606982985734],
							[101.66823198389861, 2.967635015000659],
							[101.66908298401839, 2.967983014908387],
							[101.66961601556186, 2.968747014414224],
							[101.67001398360578, 2.969522014640118],
							[101.67068498380051, 2.969962014248575],
							[101.6713039841167, 2.970757014646158],
							[101.67224871894487, 2.971019302993458],
							[101.6733209840006, 2.971592014695553],
							[101.67419098438691, 2.97165898375897],
							[101.67566101536563, 2.971409014644233],
							[101.6762389842329, 2.971799015025864],
							[101.67690501494751, 2.971633983171918],
							[101.67748701545378, 2.97123701489675],
							[101.67873898399053, 2.971745983429197],
							[101.67882998422708, 2.971486014277311],
							[101.67932198432173, 2.971557014947874],
							[101.67938027150892, 2.96965163971425],
							[101.67941407690968, 2.96870844587392],
							[101.67943288044519, 2.967890680723403],
							[101.67947180085319, 2.966086182089542],
							[101.67950693935389, 2.964310936272744],
							[101.67953135825826, 2.962448770644155],
							[101.6795760153076, 2.959981015020368],
							[101.68165657638777, 2.960042434325703],
							[101.68879801491151, 2.960235983657736],
							[101.68879825116841, 2.96187134524757],
							[101.68878597658838, 2.966340315006728],
							[101.6887765505661, 2.967816659246287],
							[101.68877558667383, 2.968586794201209],
							[101.68877041327607, 2.97024607112196],
							[101.68876598368342, 2.971871983032241],
							[101.6902989838686, 2.972079983584393],
							[101.69198898441262, 2.972423983686831],
							[101.69322798397161, 2.972316983074444],
							[101.69368001532425, 2.973753983037532],
							[101.69482598355579, 2.974147983679857],
							[101.69511898435711, 2.975285014715333],
							[101.69542601504648, 2.975654983187041],
							[101.69657698419923, 2.976038014262511],
							[101.69727301505101, 2.976622983171989],
							[101.69752798387808, 2.976573014518091],
							[101.69791501493344, 2.975553983617849],
							[101.69832598429444, 2.975588014366237],
							[101.69865498418238, 2.976302983693658],
							[101.69890398370443, 2.97630501473607],
							[101.69947301523298, 2.975384014663729],
							[101.70007901513034, 2.975284014444002],
							[101.70061798363956, 2.975604983090613],
							[101.70264698411732, 2.975577014972509]
						]
					]
				}
			}
		]
	};

	onMount(async () => {
		const d = doc(db, 'maps', MAP_ID);
		const snap = await getDoc(d);
		if (snap.exists()) {
			const data = (await snap.data()) as {
				markers: {
					[id: string]: { marker: GeoPoint; title: string; description: string };
				};
			};

			const n: typeof markers = {};

			const keys = Object.keys(data.markers);
			keys.forEach((key) => {
				const m = data.markers[key];
				const marker = L.marker([m.marker.latitude, m.marker.longitude]);
				marker.on({
					click: () => {
						openMarkerData(key);
					}
				});

				n[key] = {
					...data.markers[key],
					marker: marker
				};
			});

			markers = n;
		} else {
			console.log('No data');
		}
	});

	const MAP_ID = 'putrajaya';

	const center: L.LatLngExpression = [2.93522, 101.69129];
	const minZoom = 13;

	let map: L.Map;

	let markers: {
		[id: string]: { marker: L.Marker; title: string; description: string };
	} = {};

	const loadMap = (el: HTMLElement) => {
		map = L.map(el, {}).setView(center, minZoom);

		map.attributionControl.options = {
			prefix: 'Created by <a href="https://github.com/aidilrx04">@aidilrx04</a>'
		};

		L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
			minZoom: 13,
			maxZoom: 20,
			attribution: '© <a href="https://openstreetmap.org" target="_blanl">OpenStreetMap</a>'
		}).addTo(map);

		// boundary of the visible map
		const coveringPolygon = L.polygon([
			map.getBounds().getSouthWest(),
			map.getBounds().getNorthWest(),
			map.getBounds().getNorthEast(),
			map.getBounds().getSouthEast()
		]);

		// difference to highlight selected geojson
		const areaDifference = difference(
			polygon(coveringPolygon.toGeoJSON().geometry.coordinates),
			PutrajayaGeoJson.features[0]
		);

		// highlight area outside geojson with color
		L.geoJSON(areaDifference, {
			fillColor: 'black',
			fillOpacity: 0.2,
			style: {
				stroke: 100,
				color: 'orange'
			},
			attribution: '<a href="https://github.com/TindakMalaysia" target="_blank">TindakMalaysia</a>'
		}).addTo(map);

		map.setMaxBounds(map.getBounds());

		map.on({
			click: (e) => {
				handleMarkerClick(e);
			},
			resize: (e) => {
				console.log('map resized');
			}
		});
	};

	const handleMarkerClick = (e: L.LeafletMouseEvent) => {
		if (!isAddMarker) {
			return;
		}
		console.log('map clicked');
		const marker = L.marker(e.latlng);

		const markerId = uuidv4();
		markers[markerId] = { marker: marker, title: '', description: '' };

		isAddMarker = false;
		editMarkerId = markerId;
		isMenuOpen = true;

		marker.on({
			click: () => {
				console.log('Marker', markerId);
				openMarkerData(markerId);
			}
		});

		map.flyTo(e.latlng, 19, {
			animate: true,
			duration: 0.15
		});

		setTimeout(() => {
			console.log('REvalidate size');
			map.invalidateSize();
		}, 150);
	};

	$: Object.values(markers).forEach((marker) => {
		marker.marker.remove();
		marker.marker.addTo(map);
	});

	let isAddMarker = false;
	let isMenuOpen = false;
	let isModalOpen = false;

	let editMarkerId: string;
	let title = '';
	let description = '';

	let activeMarkerId: string = '';
	let activeMarker = {
		title: 'Marker title',
		description: ' marker description'
	};

	const saveMarkerData = () => {
		markers[editMarkerId] = {
			...markers[editMarkerId],
			title: title,
			description: description
		};

		// markers = [...markers];
		isMenuOpen = false;
		saveToCloud();
		setTimeout(() => {
			map.invalidateSize();
		}, 150);
	};

	$: console.log(markers);

	const openMarkerData = (id: string) => {
		const marker = markers[id];
		activeMarker = marker;
		activeMarkerId = id;

		map.flyTo(marker.marker.getLatLng(), 19, {
			animate: true,
			duration: 0.15
		});

		isModalOpen = true;
	};

	const saveToCloud = async () => {
		const maps = collection(db, 'maps');
		const putrajayaDoc = doc(maps, MAP_ID);

		const newFormat: {
			[id: string]: { marker: GeoPoint; title: string; description: string };
		} = {};

		const keys = Object.keys(markers);
		keys.forEach((key) => {
			const marker = markers[key];
			const geo = new GeoPoint(marker.marker.getLatLng().lat, marker.marker.getLatLng().lng);

			newFormat[key] = {
				...markers[key],
				marker: geo
			};
		});

		await setDoc(putrajayaDoc, {
			markers: newFormat
		});
	};
</script>

<div id="map-container">
	<div class="balls flex">
		<div
			class="actions w-[40%] {isMenuOpen
				? 'max-w-[40%]'
				: 'max-w-[0%]'} inline-block transition-all"
		>
			<h2 class="mb-4 px-4 py-3.5 font-semibold text-xl">Marker</h2>
			<hr class="mb-4" />

			<form on:submit={saveMarkerData} class="px-4">
				<div class="input-group mb-3">
					<label for="" class="block mb-2">Title</label>
					<input
						type="text"
						bind:value={title}
						class="border rounded border-slate-400 block px-4 py-3.5 w-full"
					/>
				</div>

				<div class="input-group mb-3">
					<label for="" class="block mb-2">Description</label>
					<textarea
						bind:value={description}
						class="w-full block border rounded border-slate-400 h-20 px-4 py-3.5"
					/>
				</div>
				<button type="submit" class="px-3 py-3.5 block w-full text-white bg-blue-600 rounded mb-4">
					Save
				</button>
				<button
					class="border-2 border-blue-600 px-3 py-3.5 block w-full rounded bg-blue-50"
					on:click={() => {
						isMenuOpen = false;
						setTimeout(() => {
							map.invalidateSize();
						}, 150);
					}}
					type="button"
				>
					Close
				</button>
			</form>
		</div>
		<div id="map" use:loadMap class="w-[100%]" />
	</div>
	{#if isModalOpen}
		<div class="modal absolute top-0 left-0 w-full h-full" style="z-index: 9999;">
			<!-- svelte-ignore a11y-click-events-have-key-events -->
			<!-- svelte-ignore a11y-no-static-element-interactions -->
			<div
				class="bg-slate-900 bg-opacity-25 w-full h-full absolute top-0 left-0"
				on:click={() => (isModalOpen = false)}
			/>
			<div class="content bg-white absolute w-[60%] top-20 left-1/2 -translate-x-1/2 rounded-lg">
				<h2 class="font-semibold py-3 px-4 text-xl border-b-2 border-slate-100">
					{activeMarker.title}
				</h2>

				<p class="px-4 py-3">{activeMarker.description}</p>

				<button
					class="px-3 py-2.5 rounded bg-slate-100 inline-block mx-4 my-3"
					on:click={() => (isModalOpen = false)}>Close</button
				>
				<button
					class="inline-block mx-4 my-3 px-3 py-2.5 rounded bg-red-50 text-red-900"
					on:click={() => {
						markers[activeMarkerId].marker.remove();
						delete markers[activeMarkerId];
						saveToCloud();
						isModalOpen = false;
					}}>Delete</button
				>
			</div>
		</div>
	{/if}
	<div style="z-index: 9999;">
		<button
			on:click={() => {
				alert('Click on map to place marker');
				isAddMarker = true;
			}}
			class="px-3 py-2.5 rounded mx-4 my-4 bg-blue-600 text-white">Add Marker</button
		>
	</div>
</div>

<style>
	#map-container {
		height: 680px;
		position: relative;
	}
	.balls {
		height: 100%;
	}
	#map {
		height: 100%;
	}
	#modal {
		position: absolute;
		top: 50%;
		left: 50%;
		z-index: 9999;
		background-color: white;
		padding: 10px 20px;
		/* translate: -50%, -50%; */
		transform: translate(-50%, -50%);
	}

	.my-div-icon {
		content: 'Balls';
	}
</style>
